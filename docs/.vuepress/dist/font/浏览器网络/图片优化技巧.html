<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、为什么要对图片进行优化 | niping</title>
    <meta name="description" content="欢迎来到我的博客">
    <link rel="icon" href="/logo.jpg">
    
    <link rel="preload" href="/assets/css/0.styles.b8bd58f1.css" as="style"><link rel="preload" href="/assets/js/app.e32243dc.js" as="script"><link rel="preload" href="/assets/js/11.d906bdb3.js" as="script"><link rel="prefetch" href="/assets/js/10.83e9406f.js"><link rel="prefetch" href="/assets/js/100.772ca587.js"><link rel="prefetch" href="/assets/js/101.a1d18f4d.js"><link rel="prefetch" href="/assets/js/102.c0b0e9d2.js"><link rel="prefetch" href="/assets/js/12.bc50bcfd.js"><link rel="prefetch" href="/assets/js/13.d4e1039d.js"><link rel="prefetch" href="/assets/js/14.f295ebc6.js"><link rel="prefetch" href="/assets/js/15.57d01c59.js"><link rel="prefetch" href="/assets/js/16.de3850c8.js"><link rel="prefetch" href="/assets/js/17.f53563f3.js"><link rel="prefetch" href="/assets/js/18.e7019d87.js"><link rel="prefetch" href="/assets/js/19.57b28dd6.js"><link rel="prefetch" href="/assets/js/2.a5189228.js"><link rel="prefetch" href="/assets/js/20.f4867b2d.js"><link rel="prefetch" href="/assets/js/21.6222980b.js"><link rel="prefetch" href="/assets/js/22.4612fa57.js"><link rel="prefetch" href="/assets/js/23.889bf2e4.js"><link rel="prefetch" href="/assets/js/24.80f5ce79.js"><link rel="prefetch" href="/assets/js/25.7fd56dcd.js"><link rel="prefetch" href="/assets/js/26.9086638d.js"><link rel="prefetch" href="/assets/js/27.5024530d.js"><link rel="prefetch" href="/assets/js/28.99f458a6.js"><link rel="prefetch" href="/assets/js/29.1d5c7a4b.js"><link rel="prefetch" href="/assets/js/3.183b94e7.js"><link rel="prefetch" href="/assets/js/30.c5b70c6e.js"><link rel="prefetch" href="/assets/js/31.5b7377cd.js"><link rel="prefetch" href="/assets/js/32.4a581615.js"><link rel="prefetch" href="/assets/js/33.d41cf213.js"><link rel="prefetch" href="/assets/js/34.5d0df144.js"><link rel="prefetch" href="/assets/js/35.4f9a1d94.js"><link rel="prefetch" href="/assets/js/36.b3310185.js"><link rel="prefetch" href="/assets/js/37.024b0d98.js"><link rel="prefetch" href="/assets/js/38.73181322.js"><link rel="prefetch" href="/assets/js/39.9ff90ac1.js"><link rel="prefetch" href="/assets/js/4.a61f3e3a.js"><link rel="prefetch" href="/assets/js/40.d2374e70.js"><link rel="prefetch" href="/assets/js/41.c15ea2da.js"><link rel="prefetch" href="/assets/js/42.7682cf87.js"><link rel="prefetch" href="/assets/js/43.6e834b91.js"><link rel="prefetch" href="/assets/js/44.8d5a08ad.js"><link rel="prefetch" href="/assets/js/45.f6e74994.js"><link rel="prefetch" href="/assets/js/46.2fc4dca2.js"><link rel="prefetch" href="/assets/js/47.155984da.js"><link rel="prefetch" href="/assets/js/48.9a8fb143.js"><link rel="prefetch" href="/assets/js/49.03235ca1.js"><link rel="prefetch" href="/assets/js/5.18daef18.js"><link rel="prefetch" href="/assets/js/50.55c45af0.js"><link rel="prefetch" href="/assets/js/51.d1987f26.js"><link rel="prefetch" href="/assets/js/52.f708cb6c.js"><link rel="prefetch" href="/assets/js/53.a65c452c.js"><link rel="prefetch" href="/assets/js/54.4ef1269b.js"><link rel="prefetch" href="/assets/js/55.1c8f1e27.js"><link rel="prefetch" href="/assets/js/56.798ff00c.js"><link rel="prefetch" href="/assets/js/57.3871f25c.js"><link rel="prefetch" href="/assets/js/58.33171868.js"><link rel="prefetch" href="/assets/js/59.5442134d.js"><link rel="prefetch" href="/assets/js/6.f4aa95ed.js"><link rel="prefetch" href="/assets/js/60.b31f65fe.js"><link rel="prefetch" href="/assets/js/61.62c8a909.js"><link rel="prefetch" href="/assets/js/62.f8d47c5d.js"><link rel="prefetch" href="/assets/js/63.2c7fdac7.js"><link rel="prefetch" href="/assets/js/64.ef1c7225.js"><link rel="prefetch" href="/assets/js/65.a836f04a.js"><link rel="prefetch" href="/assets/js/66.5210ceda.js"><link rel="prefetch" href="/assets/js/67.58a25ce9.js"><link rel="prefetch" href="/assets/js/68.c14b559e.js"><link rel="prefetch" href="/assets/js/69.534fe714.js"><link rel="prefetch" href="/assets/js/7.4b50afb9.js"><link rel="prefetch" href="/assets/js/70.049ae0ee.js"><link rel="prefetch" href="/assets/js/71.1ebfc569.js"><link rel="prefetch" href="/assets/js/72.4455d7a8.js"><link rel="prefetch" href="/assets/js/73.a07a4f0b.js"><link rel="prefetch" href="/assets/js/74.6e12492c.js"><link rel="prefetch" href="/assets/js/75.cff61a2c.js"><link rel="prefetch" href="/assets/js/76.9576355c.js"><link rel="prefetch" href="/assets/js/77.bc3d3388.js"><link rel="prefetch" href="/assets/js/78.6312c87d.js"><link rel="prefetch" href="/assets/js/79.48df875a.js"><link rel="prefetch" href="/assets/js/8.aa1db0c1.js"><link rel="prefetch" href="/assets/js/80.7ab5a229.js"><link rel="prefetch" href="/assets/js/81.913ad205.js"><link rel="prefetch" href="/assets/js/82.b5a31b64.js"><link rel="prefetch" href="/assets/js/83.9e90d84a.js"><link rel="prefetch" href="/assets/js/84.0dd167e9.js"><link rel="prefetch" href="/assets/js/85.7a233624.js"><link rel="prefetch" href="/assets/js/86.c56a55c4.js"><link rel="prefetch" href="/assets/js/87.27d7fa6e.js"><link rel="prefetch" href="/assets/js/88.91e11988.js"><link rel="prefetch" href="/assets/js/89.2cda756b.js"><link rel="prefetch" href="/assets/js/9.bf5e75ba.js"><link rel="prefetch" href="/assets/js/90.10f2d574.js"><link rel="prefetch" href="/assets/js/91.ec7a94b5.js"><link rel="prefetch" href="/assets/js/92.e1f902a2.js"><link rel="prefetch" href="/assets/js/93.f4cf637f.js"><link rel="prefetch" href="/assets/js/94.5d1761f6.js"><link rel="prefetch" href="/assets/js/95.901893ad.js"><link rel="prefetch" href="/assets/js/96.97305238.js"><link rel="prefetch" href="/assets/js/97.cda1bbae.js"><link rel="prefetch" href="/assets/js/98.9dd210a6.js"><link rel="prefetch" href="/assets/js/99.c74a3e5c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b8bd58f1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">niping</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">HOME</a></div><div class="nav-item"><a href="/font/" class="nav-link router-link-active">前端</a></div><div class="nav-item"><a href="/computer/" class="nav-link">计算机</a></div><div class="nav-item"><a href="/other/" class="nav-link">个人学习笔记</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">关于我</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.instagram.com/nipingd/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  instagram
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/nipingd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">HOME</a></div><div class="nav-item"><a href="/font/" class="nav-link router-link-active">前端</a></div><div class="nav-item"><a href="/computer/" class="nav-link">计算机</a></div><div class="nav-item"><a href="/other/" class="nav-link">个人学习笔记</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">关于我</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.instagram.com/nipingd/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  instagram
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/nipingd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>JS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>浏览器网络</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/font/浏览器网络/URL到页面呈现过程总结.html" class="sidebar-link">URL到页面呈现过程总结</a></li><li><a href="/font/浏览器网络/Web安全.html" class="sidebar-link">Web安全</a></li><li><a href="/font/浏览器网络/Cookie、Session和Web Storage、token.html" class="sidebar-link">Cookie、Session和Web Storage、token</a></li><li><a href="/font/浏览器网络/跨域实现.html" class="sidebar-link">跨域实现</a></li><li><a href="/font/浏览器网络/CORS通信详解.html" class="sidebar-link">CORS通信详解</a></li><li><a href="/font/浏览器网络/浏览器缓存.html" class="sidebar-link">浏览器缓存</a></li><li><a href="/font/浏览器网络/页面性能优化.html" class="sidebar-link">页面性能优化</a></li><li><a href="/font/浏览器网络/网络基础.html" class="sidebar-link">网络基础</a></li><li><a href="/font/浏览器网络/前端路由.html" class="sidebar-link">前端路由</a></li><li><a href="/font/浏览器网络/chrome调试技巧.html" class="sidebar-link">chrome调试技巧</a></li><li><a href="/font/浏览器网络/网络零散知识整理.html" class="sidebar-link">网络零散知识整理</a></li><li><a href="/font/浏览器网络/浏览器零散知识整理.html" class="sidebar-link">浏览器零散知识整理</a></li><li><a href="/font/浏览器网络/HTTP面试题.html" class="sidebar-link">HTTP面试题</a></li><li><a href="/font/浏览器网络/TCP面试题.html" class="sidebar-link">TCP面试题</a></li><li><a href="/font/浏览器网络/前端安全面试题.html" class="sidebar-link">前端安全面试题</a></li><li><a href="/font/浏览器网络/浏览器面试题.html" class="sidebar-link">浏览器面试题</a></li><li><a href="/font/浏览器网络/Web Workers.html" class="sidebar-link">Web Workers</a></li><li><a href="/font/浏览器网络/图片优化技巧.html" class="active sidebar-link">图片优化技巧</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/font/浏览器网络/图片优化技巧.html#一、为什么要对图片进行优化" class="sidebar-link">一、为什么要对图片进行优化</a></li><li class="sidebar-sub-header"><a href="/font/浏览器网络/图片优化技巧.html#二、从图片大小开始优化" class="sidebar-link">二、从图片大小开始优化</a></li><li class="sidebar-sub-header"><a href="/font/浏览器网络/图片优化技巧.html#三、通过图片按需加载减少请求压力" class="sidebar-link">三、通过图片按需加载减少请求压力</a></li><li class="sidebar-sub-header"><a href="/font/浏览器网络/图片优化技巧.html#四、响应式图片的实践" class="sidebar-link">四、响应式图片的实践</a></li><li class="sidebar-sub-header"><a href="/font/浏览器网络/图片优化技巧.html#五、安全地使用webp图片" class="sidebar-link">五、安全地使用WebP图片</a></li><li class="sidebar-sub-header"><a href="/font/浏览器网络/图片优化技巧.html#六、对base64url的反思" class="sidebar-link">六、对Base64Url的反思</a></li><li class="sidebar-sub-header"><a href="/font/浏览器网络/图片优化技巧.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><p>以下文章来源于前端漫游指南 ，作者fecoder</p> <h2 id="一、为什么要对图片进行优化"><a href="#一、为什么要对图片进行优化" aria-hidden="true" class="header-anchor">#</a> 一、为什么要对图片进行优化</h2> <p>对于大多数前端工程师来说，图片就是UI设计师(或者自己)切好的图，你要做的只是把图片丢进项目中，然后用以链接的方式呈现在页面上，而且我们也经常把精力放在项目的打包优化构建上，如何分包，如何抽取第三方库……..有时我们会忘了，<strong>图片才是一个网站最大头的那块加载资源</strong>(见下图)，虽然图片加载可以不不阻碍页面渲染，但优化图片，绝对可以让网站的体验提升一个档次。</p> <p><img src="/assets/img/1575165649354.f1a971cf.png" alt="1575165649354"></p> <h2 id="二、从图片大小开始优化"><a href="#二、从图片大小开始优化" aria-hidden="true" class="header-anchor">#</a> 二、从图片大小开始优化</h2> <p>压缩图片可以使用统一的压缩工具 — imagemin，它是一款可以集成多个压缩库的工具，支持jpg，png，webp等等格式的图片压缩，比如pngquant，mozjpeg等等，作为测试用途，我们可以直接安装imagemin-pngquant来尝试png图片的压缩:</p> <h3 id="png压缩"><a href="#png压缩" aria-hidden="true" class="header-anchor">#</a> PNG压缩</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>    <span class="token function">npm</span> <span class="token function">install</span> imagemin    
    <span class="token function">npm</span> <span class="token function">install</span> imagemin-pngquant
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里先安装imagemin库，再安装对应的png压缩库</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> imagemin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'imagemin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> imageminPngquant <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'imagemin-pngquant'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'images/*.png'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'build/images'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">imageminPngquant</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      quality<span class="token punctuation">:</span> <span class="token string">'65-80'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Images optimized'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>我们可以在quailty一项决定压缩比率，65-80貌似是一个在压缩率和质量之间实现平衡的数值，腾讯AlloyTeam出品的gka图片处理工具，同样使用到了imagemin库，他们默认也是使用65-80的选项：
gka代码
用它压缩一张png图片，我们看看效果如何:</p> <p>这是压缩前的：</p> <p><img src="/assets/img/image-20191201100322312.ff3fb567.png" alt="image-20191201100322312"></p> <p>这是压缩后的：</p> <p><img src="/assets/img/image-20191201100339926.65bf1adb.png" alt="image-20191201100339926"></p> <p>从肉眼上几乎看不出区别，但实际上减少了百分之77的体积！读者可以自己保存图片进行比较。</p> <h3 id="jpg-jpeg压缩与渐进式图片"><a href="#jpg-jpeg压缩与渐进式图片" aria-hidden="true" class="header-anchor">#</a> JPG/JPEG压缩与渐进式图片</h3> <p>压缩jpg/jpeg图片的方式与png类似，imagemin提供了两个插件：jpegtrain和mozjpeg供我们使用。一般我们选择mozjpeg，它拥有更丰富的压缩选项:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>    <span class="token function">npm</span> <span class="token function">install</span> imagemin-mozjpeg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> imagemin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'imagemin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> imageminMozjpeg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'imagemin-mozjpeg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'images/*.jpg'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'build/images'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    use<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">imageminMozjpeg</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      quality<span class="token punctuation">:</span> <span class="token number">65</span><span class="token punctuation">,</span>
      progressive<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Images optimized'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>注意到我们使用了progressive: true选项，这可以将图片转换为渐进式图片，关于😋<strong>渐进式图片，它允许在加载照片的时候，如果网速比较慢的话，先显示一个类似模糊有点小马赛克的质量比较差的照片，然后慢慢的变为清晰的照片：</strong></p> <p><img src="/assets/img/image-20191201100443668.96dda287.png" alt="image-20191201100443668"></p> <p>而相比之下，非渐进式的图片(Baseline JPEG)则会老老实实地从头到尾去加载：</p> <p><img src="/assets/img/image-20191201100453810.b5d812c1.png" alt="image-20191201100453810"></p> <p>张鑫旭大神的这篇文章，可以帮你更好地了解两者的区别：
渐进式jpeg(progressive jpeg)图片及其相关
简单来说，<strong>渐进式图片一开始就决定了大小，而不像Baseline图片一样，不断地从上往下加载，从而造成多次回流，但渐进式图片需要消耗CPU去多次计算渲染，这是其主要缺点。</strong>
当然，交错式png也可以实现相应的效果，但目前pngquant没有实现转换功能，但是ps中导出png时是可以设置为交错式的。</p> <h3 id="在真实项目中如何操作？"><a href="#在真实项目中如何操作？" aria-hidden="true" class="header-anchor">#</a> 在真实项目中如何操作？</h3> <p>实际项目中，总不能UI丢一个图过来你就跑一遍压缩代码吧？幸好imagemin有对应的webpack插件，在webpack遍地使用的今天，我们可以轻松实现批量压缩：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>    <span class="token function">npm</span> <span class="token function">install</span> imagemin-webpack-plugin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>先安装imagemin-webpack-plugin</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> ImageminPlugin <span class="token keyword">from</span> <span class="token string">'imagemin-webpack-plugin'</span>
<span class="token keyword">import</span> imageminMozjpeg <span class="token keyword">from</span> <span class="token string">'imagemin-mozjpeg'</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">ImageminPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">imageminMozjpeg</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      quality<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      progressive<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>接着在webpack配置文件中，引入自己需要的插件，使用方法完全相同。具体可参考github的文档imagemin-webpack-plugin</p> <h2 id="三、通过图片按需加载减少请求压力"><a href="#三、通过图片按需加载减少请求压力" aria-hidden="true" class="header-anchor">#</a> 三、通过图片按需加载减少请求压力</h2> <p>图片按需加载是个老生常谈的话题，传统做法自然是通过监听页面滚动位置，符合条件了再去进行资源加载，我们看看如今还有什么方法可以做到按需加载。</p> <h3 id="使用强大的intersectionobserver"><a href="#使用强大的intersectionobserver" aria-hidden="true" class="header-anchor">#</a> 使用强大的IntersectionObserver</h3> <p>IntersectionObserver提供给我们一项能力：可以用来监听元素是否进入了设备的可视区域之内，这意味着：我们等待图片元素进入可视区域后，再决定是否加载它，毕竟用户没看到图片前，根本不关心它是否已经加载了。
这是Chrome51率先提出和支持的API，而在2019年的今天，各大浏览器对它的支持度已经有所改善(除了IE，全线崩~)：</p> <p><img src="/assets/img/image-20191201101250840.ad5bddbb.png" alt="image-20191201101250840"></p> <p>废话不多说，上代码：
首先，假设我们有一个图片列表，它们的src属性我们暂不设置，而用data-src来替代：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>list-item-img<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>loading<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>a.jpg<span class="token punctuation">'</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>list-item-img<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>loading<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>b.jpg<span class="token punctuation">'</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>list-item-img<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>loading<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>c.jpg<span class="token punctuation">'</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>list-item-img<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>loading<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>d.jpg<span class="token punctuation">'</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这样会导致图片无法加载，这当然不是我们的目的，我们想做的是，当IntersectionObserver监听到图片元素进入可视区域时，将data-src”还给”src属性，这样我们就可以实现图片加载了:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">changes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  changes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当这个值大于0，说明满足我们的加载条件了，这个值可通过rootMargin手动设置    </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>intersectionRatio <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 放弃监听，防止性能浪费，并加载图片。      </span>
      observer<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
      element<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src <span class="token operator">=</span> element<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">initObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> listItems <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'.list-item-img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  listItems<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对每个list元素进行监听    </span>
    observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">initObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>运行代码并观察控制台的Network，会发现图片随着可视区域的移动而加载，我们的目的达到了。</p> <p><img src="/assets/img/image-20191201101439656.5343029f.png" alt="image-20191201101439656"></p> <p>(ps: 这里额外介绍一个vue的图片懒加载组件vue-view-lazy，也是基于IntersectionObserver实现的)。</p> <h3 id="还是chrome的黑科技——loading属性"><a href="#还是chrome的黑科技——loading属性" aria-hidden="true" class="header-anchor">#</a> 还是Chrome的黑科技——loading属性</h3> <p>从新版本Chrome(76)开始，已经默认支持一种新的html属性——loading，它包含三种取值:auto、lazy和eager(ps: 之前有文章说是lazyload属性，后来chrome的工程师已经将其确定为loading属性，原因是lazyload语义不够明确)，我们看看这三种属性有什么不同：</p> <p><strong>auto</strong>：让浏览器自动决定是否进行懒加载，这其中的机制尚不明确。</p> <p><strong>lazy</strong>：明确地让浏览器对此图片进行懒加载，即当用户滚动到图片附近时才进行加载，但目前没有具体说明这个“附近”具体是多近。</p> <p><strong>eager</strong>：让浏览器立刻加载此图片，也不是此篇文章关注的功能。</p> <p>我们可以通过chrome的开发工具看看这个demo中的图片加载方式，我们把上一个demo中的js脚本都删掉了，只用了loading=lazy这个属性。接着，勾选工具栏中的Disabled Cache后仔细观察Network一栏，细心的人应该会发现，一张图片被分为了两次去请求！第一次的状态码是206，第二次的状态码才是200，如图所示：</p> <p><img src="/assets/img/image-20191201101506987.e9c1aa0b.png" alt="image-20191201101506987"></p> <p>这个现象跟chrome的lazy-loading功能的实现机制有关：</p> <p><strong>首先</strong>，浏览器会发送一个预请求，请求地址就是这张图片的url，但是这个请求只拉取这张图片的头部数据，大约2kb，具体做法是在请求头中设置range: bytes=0-2047，</p> <p><img src="/assets/img/image-20191201101519620.922e68e8.png" alt="image-20191201101519620"></p> <p>而从这段数据中，浏览器就可以解析出图片的宽高等基本维度，接着浏览器立马为它生成一个空白的占位，以免图片加载过程中页面不断跳动，这很合理，总不能为了一个懒加载，让用户牺牲其他方面的体验吧？这个请求返回的状态码是206，表明：客户端通过发送范围请求头Range抓取到了资源的部分数据，详细的状态码解释可以看看这篇文章</p> <p><strong>然后</strong>，在用户滚动到图片附近时，再发起一个请求，完整地拉取图片的数据下来，这个才是我们熟悉的状态码200请求。</p> <p>可以预测到，如果以后这个属性被普遍使用，那一个服务器要处理的图片请求连接数可能会变成两倍，对服务器的压力会有所增大，但时代在进步，我们可以依靠http2多路复用的特性来缓解这个压力，这时候就需要技术负责人权衡利弊了</p> <p><strong>要注意</strong>，使用这项特性进行图片懒加载时，记得先进行兼容性处理，对不支持这项属性的浏览器，转而使用JavaScript来实现，比如上面说到的IntersectionObserver：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;loading&quot;</span> <span class="token keyword">in</span> <span class="token class-name">HTMLImageElement</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token punctuation">{</span>      
        <span class="token comment">// 没毛病    </span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      
        <span class="token comment">// .....    </span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="还可以做到锦上添花！"><a href="#还可以做到锦上添花！" aria-hidden="true" class="header-anchor">#</a> 还可以做到锦上添花！</h5> <p>以上介绍的两种方式，其实最终实现的效果是相似的，但这里还有个问题，当网速慢的时候，图片还没加载完之前，用户会看到一段空白的时间，在这段空白时间，就算是渐进式图片也无法发挥它的作用，我们需要更友好的展示方式来弥补这段空白，有一种方法简单粗暴，那就是用一张占位图来顶替，这张占位图被加载过一次后，即可从缓存中取出，无须重新加载，但这种图片会显得有些千篇一律，并不能很好地做到preview的效果。
这里我向大家介绍另一种占位图做法——<strong>css渐变色背景</strong>，原理很简单，当img标签的图片还没加载出来，我们可以为其设置背景色，比如:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>a.jpg<span class="token punctuation">&quot;</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">background</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这样会先显示出红色背景，再渲染出真实的图片，重点来了，我们此时要借用工具为这张图片”配制”出合适的渐变背景色，以达到部分preview的效果，我们可以使用https://calendar.perfplanet.com/2018/gradient-image-placeholders/ 这篇文章中推荐的工具GIP进行转换，这里附上在线转换的地址https://tools.w3clubs.com/gip/
经过转换后，我们得到了下面这串代码：</p> <div class="language-css line-numbers-mode"><pre class="language-css"><code>    <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span>      
		to bottom<span class="token punctuation">,</span>      
		#1896f5 0%<span class="token punctuation">,</span>      
		#2e6d14 100%    
	<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最终效果如下所示：</p> <p><img src="/assets/img/image-20191201101742444.1303bdec.png" alt="image-20191201101742444"></p> <p><img src="/assets/img/image-20191201101748596.7350a344.png" alt="image-20191201101748596"></p> <h2 id="四、响应式图片的实践"><a href="#四、响应式图片的实践" aria-hidden="true" class="header-anchor">#</a> 四、响应式图片的实践</h2> <p>我们经常会遇到这种情况：一张在普通笔记本上显示清晰的图片，到了苹果的Retina屏幕或是其他高清晰度的屏幕上，就变得模糊了。</p> <p>这是因为，在同样尺寸的屏幕上，高清屏可以展示的物理像素点比普通屏多，比如Retina屏，同样的屏幕尺寸下，它的物理像素点的个数是普通屏的4倍(2 * 2)，所以普通屏上显示清晰的图片，在高清屏上就像是被放大了，自然就变得模糊了，要从图片资源上解决这个问题，就需要在设备像素密度为2的高清屏中，对应地展示一张两倍大小的图。</p> <p><img src="/assets/img/image-20191201101802092.2c47fa36.png" alt="image-20191201101802092"></p> <p>而通常来讲，对于背景图片，我们可以使用css的@media进行媒体查询，以决定不同像素密度下该用哪张倍图，例如：</p> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">.bg</span> <span class="token punctuation">{</span>
  <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url">url(&quot;bg.png&quot;)</span><span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
  <span class="token property">background-size</span><span class="token punctuation">:</span> 100% 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">-webkit-min-device-pixel-ratio</span><span class="token punctuation">:</span> 2<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token property">min-device-pixel-ratio</span><span class="token punctuation">:</span> 2<span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">.bg</span> <span class="token punctuation">{</span>
    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url">url(&quot;bg@2x.png&quot;)</span> // 尺寸为200 * 200的图        
  <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这么做有两个好处，一是保证高像素密度的设备下，图片仍能保持应有的清晰度，二是防止在低像素密度的设备下加载大尺寸图片造成浪费。</p> <p>那么如何处理img标签呢？</p> <p>我们可以使用HTML5中img标签的srcset来达到这个效果，看看下面这段代码：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>320<span class="token punctuation">&quot;</span></span>  <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>bg@2x.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>bg.png 1x;bg@2x.png 2x<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这段代码的作用是：当设备像素密度，也就是dpr(devicePixelRatio)为1时，使用bg.png，为2时使用二倍图bg@2x.png，依此类推，你可以根据需要设置多种精度下要加载的图片，如果没有命中，浏览器会选择最邻近的一个精度对应的图片进行加载。
要注意：老旧的浏览器不支持srcset的特性，它会继续正常加载src属性引用的图像。</p> <h2 id="五、安全地使用webp图片"><a href="#五、安全地使用webp图片" aria-hidden="true" class="header-anchor">#</a> 五、安全地使用WebP图片</h2> <p>WebP的优势这里不再赘述，简单来说就是：同样尺寸的图片，WebP能保证比未压缩过的png、jpg、gif等格式的图片减少百分之40-70(甚至90)的比例，且保证较高的质量，更可以支持显示动态图和透明通道。</p> <p><img src="/assets/img/image-20191201101954128.19d31d99.png" alt="image-20191201101954128"></p> <p>但目前WebP的兼容性并不太好：</p> <p><img src="/assets/img/image-20191201102008727.8dde83a7.png" alt="image-20191201102008727"></p> <p>但我们可以通过两种方式，对暂未支持webp的浏览器进行兼容：</p> <h3 id="picture结合source标签"><a href="#picture结合source标签" aria-hidden="true" class="header-anchor">#</a> picture结合source标签</h3> <p>HTML5的picture标签，可以理解为相框，里面可以支持多种格式的图片，并保留一张默认底图：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>picture</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>bg.webp<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>image/webp<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">srcset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>bg.jpg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>image/jpeg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>bg.jpg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>背景图<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>picture</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>有了这段代码，浏览器会自动根据是否支持webp格式来选择加载哪张图片，若不支持，则会显示bg.jpg，如果浏览器连picture都不支持，那么会fallback到默认的img图片，这是必不可少的一个选项。</p> <p>而且这里要注意source的放置顺序，如果把jpg放在第一位，webp放在第二位，即使浏览器支持webp，那也会选择加载jpg图片。</p> <h3 id="借助cdn服务自动判断"><a href="#借助cdn服务自动判断" aria-hidden="true" class="header-anchor">#</a> 借助cdn服务自动判断</h3> <p>目前，有些图片cdn服务可以开启自动兼容webp的模式，即支持webp的浏览器则将原图转换为webp图片并返回，否则直接返回原图。实现这个功能的原理是，根据浏览器发起的请求头中的Accept属性中是否包含webp格式来判断：</p> <p><img src="/assets/img/image-20191201102149777.4b70e58f.png" alt="image-20191201102149777"></p> <p>有则说明浏览器支持webp格式，这对开发者来说可能是最简单的兼容方案，但是依赖于后端服务。</p> <p>接下来，谈一谈我认为应该反思的负优化手段：</p> <h2 id="六、对base64url的反思"><a href="#六、对base64url的反思" aria-hidden="true" class="header-anchor">#</a> 六、对Base64Url的反思</h2> <p>首先复习一下Base64的概念，😋<strong>Base64就是一种基于64个可打印字符来表示二进制数据的方法，编码过程是从二进制数据到字符串的过程，在web应用中我们经常用它来做啥呢——传输图片数据</strong>。<strong>HTML中，img的src和css样式的background-image都可以接受base64字符串，从而在页面上渲染出对应的图片</strong>。正是基于浏览器的这项能力，很多开发者提出了将多张图片转换为base64字符串，放进css样式文件中的“优化方式”，这样做的目的只有一个——<strong>减少HTTP请求数</strong>。但实际上，在如今的应用开发中，这种做法大多数情况是“负优化”效果，接下来让我们细数base64 Url的“罪状”：</p> <h3 id="第一、让css文件的体积失去控制"><a href="#第一、让css文件的体积失去控制" aria-hidden="true" class="header-anchor">#</a> 第一、让css文件的体积失去控制</h3> <p>当你把图片转换为base64字符串之后，字符串的体积一般会比原图更大，一般会多出接近3成的大小，如果你一个页面中有20张平均大小为50kb的图片，转它们为base64后，你的css文件将可能增大1.2mb的大小，这样将严重阻碍浏览器的关键渲染路径：</p> <p><img src="/assets/img/image-20191201102408567.27adc047.png" alt="image-20191201102408567"></p> <p>css文件本身就是<strong>渲染阻塞资源</strong>，浏览器首次加载时如果没有全部下载和解析完css内容就无法进行渲染树的构建，而base64的嵌入则是雪上加霜，这将把原先浏览器可以进行优化的图片异步加载，变成首屏渲染的阻塞和延迟。</p> <p>或许有人会说，webpack的url-loader可以根据图片大小决定是否转为base64(一般是小于10kb的图片)，但你也应该担心如果页面中有100张小于10kb的图片时，会给css文件增加多少体积。</p> <h3 id="第二、让浏览器的资源缓存策略功亏一篑"><a href="#第二、让浏览器的资源缓存策略功亏一篑" aria-hidden="true" class="header-anchor">#</a> 第二、让浏览器的资源缓存策略功亏一篑</h3> <p>假设你的base64Url会被你的应用多次复用，本来浏览器可以直接从本地缓存取出的图片，换成base64Url，将造成应用中多个页面重复下载1.3倍大小的文本，假设一张图片是100kb大小，被你的应用使用了10次，那么造成的流量浪费将是:(100 <em>1.3</em> 10) - 100 = 1200kb。</p> <h3 id="第三、低版本浏览器的兼容问题"><a href="#第三、低版本浏览器的兼容问题" aria-hidden="true" class="header-anchor">#</a> 第三、低版本浏览器的兼容问题</h3> <p>这是比较次要的问题，dataurl在低版本IE浏览器，比如IE8及以下的浏览器，会有兼容性问题，详细情况可以参考这篇文章。</p> <h3 id="第四、不利于开发者工具调试与查看"><a href="#第四、不利于开发者工具调试与查看" aria-hidden="true" class="header-anchor">#</a> 第四、不利于开发者工具调试与查看</h3> <p>无论哪张图片，看上去都是一堆没有意义的字符串，光看代码无法知道原图是哪张，不利于某些情况下的比对。</p> <p>说了这么多，有人可能不服气，既然这种方案缺点这么多，为啥它会从以前就被广泛使用呢？这要从早期的http协议特性说起，在http1.1之前，http协议尚未实现keep-alive，也就是每一次请求，都必须走三次握手四次挥手去建立连接，连接完又丢弃无法复用，而即使是到了http1.1的时代，keep-alive可以保证tcp的长连接，不需要多次重新建立，但由于http1.1是基于文本分割的协议，所以消息是串行的，必须有序地逐个解析，所以在这种请求“昂贵”，且早期图片体积并不是特别大，用户对网页的响应速度和体验要求也不是很高的各种前提结合下，减少图片资源的请求数是可以理解的。</p> <p>但是，在越来越多网站支持http2.0的前提下，这些都不是问题，h2是基于二进制帧的协议，在保留http1.1长连接的前提下，实现了消息的并行处理，请求和响应可以交错甚至可以复用，多个并行请求的开销已经大大降低，我已经不知道还有什么理由继续坚持base64Url的使用了。</p> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>图片优化的手段总是随着浏览器特性的升级，网络传输协议的升级，以及用户对体验要求的提升而不停地更新迭代，几年前适用的或显著的优化手段，几年后不一定仍然如此。因地制宜，多管齐下，才能将其优化做到极致！</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.e32243dc.js" defer></script><script src="/assets/js/11.d906bdb3.js" defer></script>
  </body>
</html>
