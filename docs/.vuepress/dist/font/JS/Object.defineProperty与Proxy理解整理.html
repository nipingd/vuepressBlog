<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | niping</title>
    <meta name="description" content="欢迎来到我的博客">
    <link rel="icon" href="/logo.jpg">
    
    <link rel="preload" href="/assets/css/0.styles.b8bd58f1.css" as="style"><link rel="preload" href="/assets/js/app.c404316b.js" as="script"><link rel="preload" href="/assets/js/38.41c12750.js" as="script"><link rel="prefetch" href="/assets/js/10.d862b76b.js"><link rel="prefetch" href="/assets/js/100.8bbec48b.js"><link rel="prefetch" href="/assets/js/101.5fbb19df.js"><link rel="prefetch" href="/assets/js/102.d7a151ea.js"><link rel="prefetch" href="/assets/js/103.c85d8967.js"><link rel="prefetch" href="/assets/js/104.c84a7918.js"><link rel="prefetch" href="/assets/js/11.8ffa153b.js"><link rel="prefetch" href="/assets/js/12.9610161e.js"><link rel="prefetch" href="/assets/js/13.cdfd6c38.js"><link rel="prefetch" href="/assets/js/14.83dcfd07.js"><link rel="prefetch" href="/assets/js/15.5e09dc54.js"><link rel="prefetch" href="/assets/js/16.51d1ef80.js"><link rel="prefetch" href="/assets/js/17.f3e307ff.js"><link rel="prefetch" href="/assets/js/18.e50874cd.js"><link rel="prefetch" href="/assets/js/19.5c1b47ca.js"><link rel="prefetch" href="/assets/js/2.9d915eaf.js"><link rel="prefetch" href="/assets/js/20.aa4e295a.js"><link rel="prefetch" href="/assets/js/21.6650d6a3.js"><link rel="prefetch" href="/assets/js/22.070bd54c.js"><link rel="prefetch" href="/assets/js/23.485c0a1f.js"><link rel="prefetch" href="/assets/js/24.d287a72a.js"><link rel="prefetch" href="/assets/js/25.94ede3d6.js"><link rel="prefetch" href="/assets/js/26.3c4b58a8.js"><link rel="prefetch" href="/assets/js/27.bba657b2.js"><link rel="prefetch" href="/assets/js/28.9f1efeba.js"><link rel="prefetch" href="/assets/js/29.5dc60a7e.js"><link rel="prefetch" href="/assets/js/3.29e8bddb.js"><link rel="prefetch" href="/assets/js/30.e348cdc1.js"><link rel="prefetch" href="/assets/js/31.50614c71.js"><link rel="prefetch" href="/assets/js/32.5f5adc65.js"><link rel="prefetch" href="/assets/js/33.4451abc3.js"><link rel="prefetch" href="/assets/js/34.87a94e6e.js"><link rel="prefetch" href="/assets/js/35.1a64df8c.js"><link rel="prefetch" href="/assets/js/36.b2c1576b.js"><link rel="prefetch" href="/assets/js/37.fc875cb0.js"><link rel="prefetch" href="/assets/js/39.c30a86af.js"><link rel="prefetch" href="/assets/js/4.9d3102b3.js"><link rel="prefetch" href="/assets/js/40.a3a42da0.js"><link rel="prefetch" href="/assets/js/41.40bd09ee.js"><link rel="prefetch" href="/assets/js/42.daa5719c.js"><link rel="prefetch" href="/assets/js/43.0dd848e3.js"><link rel="prefetch" href="/assets/js/44.d6831dee.js"><link rel="prefetch" href="/assets/js/45.b28edfe9.js"><link rel="prefetch" href="/assets/js/46.26607309.js"><link rel="prefetch" href="/assets/js/47.db1fd54e.js"><link rel="prefetch" href="/assets/js/48.fe482016.js"><link rel="prefetch" href="/assets/js/49.e68bd6b7.js"><link rel="prefetch" href="/assets/js/5.192c39e9.js"><link rel="prefetch" href="/assets/js/50.bbcbadb5.js"><link rel="prefetch" href="/assets/js/51.4bac396d.js"><link rel="prefetch" href="/assets/js/52.9fc199ad.js"><link rel="prefetch" href="/assets/js/53.50de3c00.js"><link rel="prefetch" href="/assets/js/54.1e850c9f.js"><link rel="prefetch" href="/assets/js/55.5d65aee9.js"><link rel="prefetch" href="/assets/js/56.d67e82bc.js"><link rel="prefetch" href="/assets/js/57.2897ba6f.js"><link rel="prefetch" href="/assets/js/58.9211cbaa.js"><link rel="prefetch" href="/assets/js/59.c5004ac4.js"><link rel="prefetch" href="/assets/js/6.3fc3e4ef.js"><link rel="prefetch" href="/assets/js/60.fa7679dc.js"><link rel="prefetch" href="/assets/js/61.dba99ea2.js"><link rel="prefetch" href="/assets/js/62.38602b18.js"><link rel="prefetch" href="/assets/js/63.d400d558.js"><link rel="prefetch" href="/assets/js/64.bd532c55.js"><link rel="prefetch" href="/assets/js/65.cee15209.js"><link rel="prefetch" href="/assets/js/66.e4d1e755.js"><link rel="prefetch" href="/assets/js/67.532fbbb0.js"><link rel="prefetch" href="/assets/js/68.dd83faf6.js"><link rel="prefetch" href="/assets/js/69.0095de62.js"><link rel="prefetch" href="/assets/js/7.b804001d.js"><link rel="prefetch" href="/assets/js/70.af6a8242.js"><link rel="prefetch" href="/assets/js/71.fe9f03db.js"><link rel="prefetch" href="/assets/js/72.658a7aa7.js"><link rel="prefetch" href="/assets/js/73.09f665a3.js"><link rel="prefetch" href="/assets/js/74.df96b2c9.js"><link rel="prefetch" href="/assets/js/75.45017907.js"><link rel="prefetch" href="/assets/js/76.a40c3b57.js"><link rel="prefetch" href="/assets/js/77.455f2a7e.js"><link rel="prefetch" href="/assets/js/78.74caf5b9.js"><link rel="prefetch" href="/assets/js/79.1c210209.js"><link rel="prefetch" href="/assets/js/8.977aad8c.js"><link rel="prefetch" href="/assets/js/80.d40a2273.js"><link rel="prefetch" href="/assets/js/81.44dc3e3a.js"><link rel="prefetch" href="/assets/js/82.7071232f.js"><link rel="prefetch" href="/assets/js/83.d50b4063.js"><link rel="prefetch" href="/assets/js/84.2e09551c.js"><link rel="prefetch" href="/assets/js/85.a7dea885.js"><link rel="prefetch" href="/assets/js/86.ebecdce5.js"><link rel="prefetch" href="/assets/js/87.5e737857.js"><link rel="prefetch" href="/assets/js/88.a717bb23.js"><link rel="prefetch" href="/assets/js/89.cee37181.js"><link rel="prefetch" href="/assets/js/9.a6bb9606.js"><link rel="prefetch" href="/assets/js/90.37276caa.js"><link rel="prefetch" href="/assets/js/91.45e51040.js"><link rel="prefetch" href="/assets/js/92.34bc803a.js"><link rel="prefetch" href="/assets/js/93.dfc2dcff.js"><link rel="prefetch" href="/assets/js/94.20ff79ff.js"><link rel="prefetch" href="/assets/js/95.269e7110.js"><link rel="prefetch" href="/assets/js/96.f3b3ecc3.js"><link rel="prefetch" href="/assets/js/97.2b44ab4e.js"><link rel="prefetch" href="/assets/js/98.9746dae5.js"><link rel="prefetch" href="/assets/js/99.aba06790.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b8bd58f1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">niping</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">HOME</a></div><div class="nav-item"><a href="/font/" class="nav-link router-link-active">前端</a></div><div class="nav-item"><a href="/computer/" class="nav-link">计算机</a></div><div class="nav-item"><a href="/other/" class="nav-link">个人学习笔记</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">关于我</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.instagram.com/nipingd/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  instagram
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/nipingd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">HOME</a></div><div class="nav-item"><a href="/font/" class="nav-link router-link-active">前端</a></div><div class="nav-item"><a href="/computer/" class="nav-link">计算机</a></div><div class="nav-item"><a href="/other/" class="nav-link">个人学习笔记</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">关于我</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.instagram.com/nipingd/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  instagram
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/nipingd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>JS</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/font/JS/this、new、apply、call与bind.html" class="sidebar-link">this、new、apply、call与bind</a></li><li><a href="/font/JS/JS单线程、异步、同步.html" class="sidebar-link">JS单线程、异步、同步</a></li><li><a href="/font/JS/常用正则表达式备忘录.html" class="sidebar-link">常用正则表达式备忘录</a></li><li><a href="/font/JS/Object.defineProperty与Proxy理解整理.html" class="active sidebar-link">Object.defineProperty与Proxy理解整理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/font/JS/Object.defineProperty与Proxy理解整理.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/font/JS/Object.defineProperty与Proxy理解整理.html#_1-基于数据劫持实现的双向绑定的特点" class="sidebar-link">1.基于数据劫持实现的双向绑定的特点</a></li><li class="sidebar-sub-header"><a href="/font/JS/Object.defineProperty与Proxy理解整理.html#_2-基于object-defineproperty双向绑定的特点" class="sidebar-link">2.基于Object.defineProperty双向绑定的特点</a></li><li class="sidebar-sub-header"><a href="/font/JS/Object.defineProperty与Proxy理解整理.html#_3-proxy实现的双向绑定的特点" class="sidebar-link">3.Proxy实现的双向绑定的特点</a></li></ul></li><li><a href="/font/JS/柯里化.html" class="sidebar-link">柯里化</a></li><li><a href="/font/JS/JS技巧.html" class="sidebar-link">JS技巧</a></li><li><a href="/font/JS/闭包.html" class="sidebar-link">闭包</a></li><li><a href="/font/JS/作用域与作用域链.html" class="sidebar-link">作用域与作用域链</a></li><li><a href="/font/JS/JS运行机制总结.html" class="sidebar-link">JS运行机制总结</a></li><li><a href="/font/JS/赋值、浅拷贝与深拷贝.html" class="sidebar-link">赋值、浅拷贝与深拷贝</a></li><li><a href="/font/JS/构造函数、原型、继承和原型链.html" class="sidebar-link">构造函数、原型、继承和原型链</a></li><li><a href="/font/JS/原生JS知识.html" class="sidebar-link">原生JS知识</a></li><li><a href="/font/JS/防抖与节流.html" class="sidebar-link">防抖与节流</a></li><li><a href="/font/JS/类型转换比较问题.html" class="sidebar-link">类型转换比较问题</a></li><li><a href="/font/JS/JS中有趣的事实.html" class="sidebar-link">JS中有趣的事实</a></li><li><a href="/font/JS/正则表达式必知必会.html" class="sidebar-link">正则表达式必知必会</a></li><li><a href="/font/JS/空对象与空数组相加问题.html" class="sidebar-link">空对象与空数组相加问题</a></li><li><a href="/font/JS/JS面试题.html" class="sidebar-link">JS面试题</a></li><li><a href="/font/JS/JS零散知识整理.html" class="sidebar-link">JS零散知识整理</a></li><li><a href="/font/JS/前端模块化.html" class="sidebar-link">前端模块化</a></li><li><a href="/font/JS/JS操作DOM常用API总结.html" class="sidebar-link">JS操作DOM常用API总结</a></li><li><a href="/font/JS/JS工具函数大全.html" class="sidebar-link">JS工具函数大全</a></li><li><a href="/font/JS/内存泄漏.html" class="sidebar-link">内存泄漏</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>typescript</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>浏览器网络</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>node</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> <strong>前言</strong></h2> <p><strong>双向绑定</strong>其实已经是一个老掉牙的问题了,只要涉及到MVVM框架就不得不谈的知识点,但它毕竟是Vue的三要素之一.</p> <p><strong>Vue三要素</strong></p> <ul><li>响应式: 例如如何监听数据变化,其中的实现方法就是我们提到的双向绑定</li> <li>模板引擎: 如何解析模板</li> <li>渲染: Vue如何将监听到的数据变化和解析后的HTML进行渲染</li></ul> <p>可以实现双向绑定的方法有很多,KnockoutJS基于观察者模式的双向绑定,Ember基于数据模型的双向绑定,Angular基于脏检查的双向绑定,本篇文章我们重点讲面试中常见的基于<strong>数据劫持</strong>的双向绑定。</p> <p>常见的基于数据劫持的双向绑定有两种实现,一个是目前Vue在用的<code>Object.defineProperty</code>,另一个是ES2015中新增的<code>Proxy</code>,而Vue的作者宣称将在Vue3.0版本后加入<code>Proxy</code>从而代替<code>Object.defineProperty</code>,通过本文你也可以知道为什么Vue未来会选择<code>Proxy</code>。</p> <blockquote><p>严格来讲Proxy应该被称为『代理』而非『劫持』,不过由于作用有很多相似之处,我们在下文中就不再做区分,统一叫『劫持』。</p></blockquote> <p>我们可以通过下图清楚看到以上两种方法在<strong>双向绑定</strong>体系中的关系.</p> <p><img src="data:image/png;base64,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" alt="1558448967802"></p> <blockquote><p>基于数据劫持的当然还有已经凉透的<code>Object.observe</code>方法,已被废弃。</p></blockquote> <blockquote><p><strong>提前声明:</strong> 我们没有对传入的参数进行及时判断而规避错误,仅仅对核心方法进行了实现.</p></blockquote> <hr> <h2 id="_1-基于数据劫持实现的双向绑定的特点"><a href="#_1-基于数据劫持实现的双向绑定的特点" aria-hidden="true" class="header-anchor">#</a> 1.基于数据劫持实现的双向绑定的特点</h2> <h3 id="_1-1-什么是数据劫持"><a href="#_1-1-什么是数据劫持" aria-hidden="true" class="header-anchor">#</a> 1.1 什么是数据劫持</h3> <p>数据劫持比较好理解,通常我们利用<code>Object.defineProperty</code>劫持对象的访问器,在属性值发生变化时我们可以获取变化,从而进行进一步操作。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 这是将要被劫持的对象</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'古天乐'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'给大家推荐一款超好玩的游戏'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'渣渣辉'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'戏我演过很多,可游戏我只玩贪玩懒月'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'来做我的兄弟'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 遍历对象,对其属性值进行劫持</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当属性值发生变化时我们可以进行额外操作</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`大家好,我系</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newVal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">say</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'渣渣辉'</span><span class="token punctuation">;</span>
<span class="token comment">//大家好,我系渣渣辉</span>
<span class="token comment">//戏我演过很多,可游戏我只玩贪玩懒月</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_1-2-数据劫持的优势"><a href="#_1-2-数据劫持的优势" aria-hidden="true" class="header-anchor">#</a> 1.2 数据劫持的优势</h3> <p>目前业界分为两个大的流派,一个是以React为首的单向数据绑定,另一个是以Angular、Vue为主的双向数据绑定。</p> <blockquote><p>其实三大框架都是既可以双向绑定也可以单向绑定,比如React可以手动绑定onChange和value实现双向绑定,也可以调用一些双向绑定库,Vue也加入了props这种单向流的api,不过都并非主流卖点。</p></blockquote> <p>单向或者双向的优劣不在我们的讨论范围,我们需要讨论一下对比其他双向绑定的实现方法,数据劫持的优势所在。</p> <ol><li>无需显示调用: 例如Vue运用数据劫持+发布订阅,直接可以通知变化并驱动视图,上面的例子也是比较简单的实现<code>data.name = '渣渣辉'</code>后直接触发变更,而比如Angular的脏检测则需要显示调用<code>markForCheck</code>(可以用zone.js避免显示调用,不展开),react需要显示调用<code>setState</code>。</li> <li>可精确得知变化数据：还是上面的小例子，我们劫持了属性的setter,当属性值改变,我们可以精确获知变化的内容<code>newVal</code>,因此在这部分不需要额外的diff操作,否则我们只知道数据发生了变化而不知道具体哪些数据变化了,这个时候需要大量diff来找出变化值,这是额外性能损耗。</li></ol> <h3 id="_1-3-基于数据劫持双向绑定的实现思路"><a href="#_1-3-基于数据劫持双向绑定的实现思路" aria-hidden="true" class="header-anchor">#</a> 1.3 基于数据劫持双向绑定的实现思路</h3> <p><strong>数据劫持</strong>是双向绑定各种方案中比较流行的一种,最著名的实现就是Vue。</p> <p>基于数据劫持的双向绑定离不开<code>Proxy</code>与<code>Object.defineProperty</code>等方法对对象/对象属性的&quot;劫持&quot;,我们要实现一个完整的双向绑定需要以下几个要点。</p> <ol><li>利用<code>Proxy</code>或<code>Object.defineProperty</code>生成的Observer针对对象/对象的属性进行&quot;劫持&quot;,在属性发生变化后通知订阅者</li> <li>解析器Compile解析模板中的<code>Directive</code>(指令)，收集指令所依赖的方法和数据,等待数据变化然后进行渲染</li> <li>Watcher属于Observer和Compile桥梁,它将接收到的Observer产生的数据变化,并根据Compile提供的指令进行视图渲染,使得数据变化促使视图变化</li></ol> <p><img src="/assets/img/1558449032076.04656625.png" alt="1558449032076"></p> <blockquote><p>我们看到，虽然Vue运用了数据劫持，但是依然离不开<strong>发布订阅</strong>的模式，之所以在系列2做了<a href="https://juejin.im/post/5ac2fb886fb9a028b86e328c" target="_blank" rel="noopener noreferrer">Event Bus的实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,就是因为我们不管在学习一些框架的原理还是一些流行库（例如Redux、Vuex）,基本上都离不开<strong>发布订阅</strong>模式,而<em>Event</em>模块则是此模式的经典实现,所以如果不熟悉<strong>发布订阅</strong>模式,建议读一下系列2的文章。</p></blockquote> <hr> <h2 id="_2-基于object-defineproperty双向绑定的特点"><a href="#_2-基于object-defineproperty双向绑定的特点" aria-hidden="true" class="header-anchor">#</a> 2.基于Object.defineProperty双向绑定的特点</h2> <p>关于<code>Object.defineProperty</code>的文章在网络上已经汗牛充栋,我们不想花过多时间在<code>Object.defineProperty</code>上面,本节我们主要讲解<code>Object.defineProperty</code>的特点,方便接下来与<code>Proxy</code>进行对比。</p> <blockquote><p>对<code>Object.defineProperty</code>还不了解的请阅读<a href="https://link.juejin.im?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FObject%2FdefineProperty" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>两年前就有人写过基于<code>Object.defineProperty</code>实现的<a href="https://link.juejin.im?target=https%3A%2F%2Fsegmentfault.com%2Fa%2F1190000006599500" target="_blank" rel="noopener noreferrer">文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,想深入理解<code>Object.defineProperty</code>实现的推荐阅读,本文也做了相关参考。</p> <blockquote><p>上面我们推荐的文章为比较完整的实现(400行代码),我们在本节只提供一个极简版(20行)和一个简化版(150行)的实现,读者可以循序渐进地阅读。</p></blockquote> <p>2.1 极简版的双向绑定</p> <p>我们都知道,<code>Object.defineProperty</code>的作用就是劫持一个对象的属性,通常我们对属性的<code>getter</code>和<code>setter</code>方法进行劫持,在对象的属性发生变化时进行特定的操作。</p> <p>我们就对对象<code>obj</code>的<code>text</code>属性进行劫持,在获取此属性的值时打印<code>'get val'</code>,在更改属性值的时候对DOM进行操作,这就是一个极简的双向绑定。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get val'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>emsp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set val:'</span> <span class="token operator">+</span> newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> input <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keyup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  obj<span class="token punctuation">.</span>text <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在线示例 <a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io%2Fxiaomuzhu%2Fpen%2FgzmEab%2F" target="_blank" rel="noopener noreferrer">极简版双向绑定<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> by Iwobi (<a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io%2Fxiaomuzhu" target="_blank" rel="noopener noreferrer">@xiaomuzhu<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) on <a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io" target="_blank" rel="noopener noreferrer">CodePen<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h3 id="_2-2-升级改造"><a href="#_2-2-升级改造" aria-hidden="true" class="header-anchor">#</a> 2.2 升级改造</h3> <p>我们很快会发现，这个所谓的<em>双向绑定</em>貌似并没有什么乱用。。。</p> <p>原因如下:</p> <ol><li>我们只监听了一个属性,一个对象不可能只有一个属性,我们需要对对象每个属性进行监听。</li> <li>违反开放封闭原则,我们如果了解<a href="https://link.juejin.im?target=https%3A%2F%2Fzh.wikipedia.org%2Fzh-hans%2F%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99" target="_blank" rel="noopener noreferrer">开放封闭原则<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的话,上述代码是明显违反此原则,我们每次修改都需要进入方法内部,这是需要坚决杜绝的。</li> <li>代码耦合严重,我们的数据、方法和DOM都是耦合在一起的，就是传说中的面条代码。</li></ol> <p>那么如何解决上述问题？</p> <p>Vue的操作就是加入了<strong>发布订阅</strong>模式，结合<code>Object.defineProperty</code>的劫持能力，实现了可用性很高的双向绑定。</p> <p>首先，我们以<strong>发布订阅</strong>的角度看我们第一部分写的那一坨代码,会发现它的<em>监听</em>、<em>发布</em>和<em>订阅</em>都是写在一起的,我们首先要做的就是解耦。</p> <p>我们先实现一个订阅发布中心，即消息管理员（Dep）,它负责储存订阅者和消息的分发,不管是订阅者还是发布者都需要依赖于它。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 用于储存订阅者并发布消息</span>
  <span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 设置id,用于区分新Watcher和只改变属性值后新产生的Watcher</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token comment">// 储存订阅者的数组</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 触发target上的Watcher中的addDep方法,参数为dep的实例本身</span>
    <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 添加订阅者</span>
    <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通知所有的订阅者(Watcher)，触发订阅者的相应逻辑处理</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">sub</span> <span class="token operator">=&gt;</span> sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 为Dep类设置一个静态属性,默认为null,工作时指向当前的Watcher</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>现在我们需要实现监听者(Observer),用于监听属性值的变化。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 监听者,监听对象属性值的变化</span>
  <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 遍历属性值并监听</span>
    <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行监听的具体方法</span>
    <span class="token function">convert</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 给当前属性的值添加监听</span>
    <span class="token keyword">let</span> chlidOb <span class="token operator">=</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果Dep类存在target属性，将其添加到dep实例的subs数组中</span>
        <span class="token comment">// target指向一个Watcher实例，每个Watcher都是一个订阅者</span>
        <span class="token comment">// Watcher实例在实例化过程中，会读取data中的某个属性，从而触发当前get方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> val<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token parameter">newVal</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">===</span> newVal<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
        <span class="token comment">// 对新值进行监听</span>
        chlidOb <span class="token operator">=</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通知所有订阅者，数值被改变了</span>
        dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当值不存在，或者不是复杂数据类型时，不再需要继续深入监听</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value <span class="token operator">||</span> <span class="token keyword">typeof</span> value <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>那么接下来就简单了,我们需要实现一个订阅者(Watcher)。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// hash储存订阅者的id,避免重复的订阅者</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm<span class="token punctuation">;</span> <span class="token comment">// 被订阅的数据一定来自于当前Vue实例</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb<span class="token punctuation">;</span> <span class="token comment">// 当数据更新时想要做的事情</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>expOrFn <span class="token operator">=</span> expOrFn<span class="token punctuation">;</span> <span class="token comment">// 被订阅的数据</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 维护更新之前的数据</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 对外暴露的接口，用于在订阅的数据被更新时，由订阅者管理员(Dep)调用</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">addDep</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果在depIds的hash中没有当前的id,可以判断是新Watcher,因此可以添加到dep的数组中储存</span>
      <span class="token comment">// 此判断是避免同id的Watcher被多次储存</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">[</span>dep<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> dep<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当前订阅者(Watcher)读取被订阅数据的最新更新后的值时，通知订阅者管理员收集当前订阅者</span>
      Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span>_data<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>expOrFn<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 置空，用于下一个Watcher使用</span>
      Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>那么我们最后完成Vue,将上述方法挂载在Vue上。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 简化了$options的处理</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$options <span class="token operator">=</span> options<span class="token punctuation">;</span>
      <span class="token comment">// 简化了对data的处理</span>
      <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 将所有data最外层属性代理到Vue实例上</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_proxy</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 监听数据</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 对外暴露调用订阅者的接口，内部主要在指令中使用订阅者</span>
    <span class="token function">$watch</span><span class="token punctuation">(</span><span class="token parameter">expOrFn<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">_proxy</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>看下效果:</p> <p><img src="data:image/png;base64,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" alt="1558449184217"></p> <p>在线示例 <a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io%2Fxiaomuzhu%2Fpen%2FjxBRgj%2F" target="_blank" rel="noopener noreferrer">双向绑定实现---无漏洞版<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> by Iwobi (<a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io%2Fxiaomuzhu" target="_blank" rel="noopener noreferrer">@xiaomuzhu<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) on <a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io" target="_blank" rel="noopener noreferrer">CodePen<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>至此,一个简单的双向绑定算是被我们实现了。</p> <h3 id="_2-3-object-defineproperty的缺陷"><a href="#_2-3-object-defineproperty的缺陷" aria-hidden="true" class="header-anchor">#</a> 2.3 Object.defineProperty的缺陷</h3> <p>其实我们升级版的双向绑定依然存在漏洞,比如我们将属性值改为数组。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    list<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> list <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  demo<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token parameter">arr</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    li<span class="token punctuation">.</span>textContent <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    fragment<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  list<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 监听数组,每次数组变化则触发渲染函数,然而...无法监听</span>
demo<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">,</span> <span class="token parameter">list</span> <span class="token operator">=&gt;</span> <span class="token function">render</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>demo<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token number">5000</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>在线示例 <a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io%2Fxiaomuzhu%2Fpen%2FNMjKxV%2F" target="_blank" rel="noopener noreferrer">双向绑定-数组漏洞<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> by Iwobi (<a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io%2Fxiaomuzhu" target="_blank" rel="noopener noreferrer">@xiaomuzhu<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) on <a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io" target="_blank" rel="noopener noreferrer">CodePen<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>是的,<code>Object.defineProperty</code>的第一个缺陷,无法监听数组变化。 然而<a href="https://link.juejin.im?target=https%3A%2F%2Fcn.vuejs.org%2Fv2%2Fguide%2Flist.html%23%E6%95%B0%E7%BB%84%E6%9B%B4%E6%96%B0%E6%A3%80%E6%B5%8B" target="_blank" rel="noopener noreferrer">Vue的文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提到了Vue是可以检测到数组变化的，但是只有以下八种方法,<code>vm.items[indexOfItem] = newValue</code>这种是无法检测的。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">unshift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">splice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>其实作者在这里用了一些奇技淫巧,把无法监听数组的情况hack掉了,以下是方法示例。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> aryMethods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token string">'pop'</span><span class="token punctuation">,</span> <span class="token string">'shift'</span><span class="token punctuation">,</span> <span class="token string">'unshift'</span><span class="token punctuation">,</span> <span class="token string">'splice'</span><span class="token punctuation">,</span> <span class="token string">'sort'</span><span class="token punctuation">,</span> <span class="token string">'reverse'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> arrayAugmentations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

aryMethods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// 这里是原生Array的原型方法</span>
    <span class="token keyword">let</span> original <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span>

   <span class="token comment">// 将push, pop等封装好的方法定义在对象arrayAugmentations的属性上</span>
   <span class="token comment">// 注意：是属性而非原型属性</span>
    arrayAugmentations<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我被改变啦!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 调用对应的原生方法并返回结果</span>
        <span class="token keyword">return</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 将我们要监听的数组的原型指针指向上面定义的空数组对象</span>
<span class="token comment">// 别忘了这个空数组的属性上定义了我们封装好的push等方法</span>
list<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrayAugmentations<span class="token punctuation">;</span>
list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 我被改变啦！ 4</span>

<span class="token comment">// 这里的list2没有被重新定义原型指针，所以就正常输出</span>
<span class="token keyword">let</span> list2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
list2<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 4</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>由于只针对了八种方法进行了hack,所以其他数组的属性也是检测不到的,其中的坑很多,可以阅读上面提到的文档。</p> <p>我们应该注意到在上文中的实现里,我们多次用遍历方法遍历对象的属性，这就引出了<code>Object.defineProperty</code>的第二个缺陷,只能劫持对象的属性,因此我们需要对每个对象的每个属性进行遍历，如果属性值也是对象那么需要深度遍历,显然能劫持一个完整的对象是更好的选择。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><hr> <h2 id="_3-proxy实现的双向绑定的特点"><a href="#_3-proxy实现的双向绑定的特点" aria-hidden="true" class="header-anchor">#</a> 3.Proxy实现的双向绑定的特点</h2> <p>Proxy在ES2015规范中被正式发布,它在目标对象之前架设一层“拦截”，外界对该对象的访问，都必须先通过这层拦截，因此提供了一种机制，可以对外界的访问进行过滤和改写,我们可以这样认为,Proxy是<code>Object.defineProperty</code>的全方位加强版,具体的文档可以查看<a href="https://link.juejin.im?target=http%3A%2F%2Fes6.ruanyifeng.com%2F%23docs%2Fproxy" target="_blank" rel="noopener noreferrer">此处<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>;</p> <h3 id="_3-1-proxy可以直接监听对象而非属性"><a href="#_3-1-proxy可以直接监听对象而非属性" aria-hidden="true" class="header-anchor">#</a> 3.1 Proxy可以直接监听对象而非属性</h3> <p>我们还是以上文中用<code>Object.defineProperty</code>实现的极简版双向绑定为例,用Proxy进行改写。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> input <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> newObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`getting </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'text'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      input<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
      p<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keyup'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  newObj<span class="token punctuation">.</span>text <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>在线示例 <a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io%2Fxiaomuzhu%2Fpen%2FKRmwRE%2F" target="_blank" rel="noopener noreferrer">Proxy版<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> by Iwobi (<a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io%2Fxiaomuzhu" target="_blank" rel="noopener noreferrer">@xiaomuzhu<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) on <a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io" target="_blank" rel="noopener noreferrer">CodePen<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>我们可以看到,Proxy直接可以劫持整个对象,并返回一个新对象,不管是操作便利程度还是底层功能上都远强于<code>Object.defineProperty</code>。</p> <h3 id="_3-2-proxy可以直接监听数组的变化"><a href="#_3-2-proxy可以直接监听数组的变化" aria-hidden="true" class="header-anchor">#</a> 3.2 Proxy可以直接监听数组的变化</h3> <p>当我们对数组进行操作(push、shift、splice等)时，会触发对应的方法名称和<em>length</em>的变化，我们可以借此进行操作,以上文中<code>Object.defineProperty</code>无法生效的列表渲染为例。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> list <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 渲染列表</span>
<span class="token keyword">const</span> Render <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化</span>
  <span class="token function-variable function">init</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      li<span class="token punctuation">.</span>textContent <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      fragment<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    list<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 我们只考虑了增加的情况,仅作为示例</span>
  <span class="token function-variable function">change</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> li <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    li<span class="token punctuation">.</span>textContent <span class="token operator">=</span> val<span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 初始数组</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 监听数组</span>
<span class="token keyword">const</span> newArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">'length'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Render<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Render<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// push数字</span>
btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  newArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>在线示例 <a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io%2Fxiaomuzhu%2Fpen%2FzjwGoN%2F" target="_blank" rel="noopener noreferrer">Proxy列表渲染<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> by Iwobi (<a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io%2Fxiaomuzhu" target="_blank" rel="noopener noreferrer">@xiaomuzhu<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) on <a href="https://link.juejin.im?target=https%3A%2F%2Fcodepen.io" target="_blank" rel="noopener noreferrer">CodePen<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>很显然,Proxy不需要那么多hack（即使hack也无法完美实现监听）就可以无压力监听数组的变化,我们都知道,标准永远优先于hack。</p> <h3 id="_3-3-proxy的其他优势"><a href="#_3-3-proxy的其他优势" aria-hidden="true" class="header-anchor">#</a> 3.3 Proxy的其他优势</h3> <p>Proxy有多达13种拦截方法,不限于apply、ownKeys、deleteProperty、has等等是<code>Object.defineProperty</code>不具备的。</p> <p>Proxy返回的是一个新对象,我们可以只操作新的对象达到目的,而<code>Object.defineProperty</code>只能遍历对象属性直接修改。</p> <p>Proxy作为新标准将受到浏览器厂商重点持续的性能优化，也就是传说中的新标准的性能红利。</p> <p>😋<strong>Proxy</strong>:</p> <ul><li>针对对象:针对整个对象,而不是对象的某个属性</li> <li>支持数组:不需要对数组的方法进行重载，省去了众多 hack</li> <li>嵌套支持: get 里面递归调用 Proxy 并返回</li></ul> <p>当然,Proxy的劣势就是兼容性问题,而且无法用polyfill磨平,因此Vue的作者才声明需要等到下个大版本(3.0)才能用Proxy重写。</p> <p>作者：寻找海蓝96</p> <p>链接：https://juejin.im/post/5acd0c8a6fb9a028da7cdfaf</p> <p>来源：掘金</p> <p>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p> <p>另一篇文章:<a href="https://www.cxymsg.com/guide/devsProxy.html" target="_blank" rel="noopener noreferrer">https://www.cxymsg.com/guide/devsProxy.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新时间: </span> <span class="time">9/6/2019, 12:28:30 AM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.c404316b.js" defer></script><script src="/assets/js/38.41c12750.js" defer></script>
  </body>
</html>
